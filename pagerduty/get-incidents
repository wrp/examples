#!/bin/sh

# Get recent unresolved incidents.  Set RESOLVED to see all.
# If $1 is specified, limit search to that service,
# otherwise get incidents for $PD_SERVICE, or (if empty) all incidents (up to 1st 100).

# If $2 is given, it should be an ISO 8601 formatted time: only incidents
# after that time are included.  Default is one week ago.

# Full list of services can be found by GETting services/ from PD.
# eg:
# ./query services | jq -rc .servi'ces[] | [ .id, .name ] | @tsv'
# (Use ./list-all-services to account for pagination)

# If RESOLVED is set in the environment, also return resolved incidents


main() {
	items_per_page=25
	parse_services "${1-$PD_SERVICE}"   # Can be a colon separated list
	parse_start_date "${2-$(date -v -1w -Iseconds)}"
	offset=0

	while curl -fsS \
		-H 'Accept: application/vnd.pagerduty+json;version=2' \
		-H "Authorization: Token token=${PD_TOKEN:?}" \
		--data-urlencode limit=$items_per_page \
		-X GET \
		"https://api.pagerduty.com/incidents"$( :
		)"?since=$start_date"$( :
		)"&offset=$offset"$( :
		)"&statuses[]=triggered"$( :
		)"&statuses[]=acknowledged"$( :
		)${RESOLVED:+"&statuses[]=resolved"}$( :
		)"&urgencies[]=high"$( :
		)"&sort_by=incident_number:DESC"$( :
		)"${services}" \
	| jq '., .more' \
	| awk '$0 == "true" {exit 0} $0 == "false" {exit 1} 1' \
	; do
		: $(( offset += $items_per_page ))
	done \
	| jq -rc '.incidents[] | [
		.service.id,
		.assignments[].assignee.summary,
		.created_at,
		.incident_number,
		.status,
		.title
	] | @tsv' \
	| ${PAGER-more}
}

parse_services() {
	unset services
	while read service; do
		services="${services}&service_ids[]=${service}"
	done <<- EOF
	$(echo $1 | tr : \\n)
	EOF
}

# If start date is not of the form "YYYY-MM-DDTHH:mm:ss-dd:dd", try
# to use it as an argument to date to generate a timestamp
parse_start_date() {
	start_date=${1}
	local d='[0-9]'

	case $start_date in
	$d$d$d$d-[01]$d-[0-3]${d}T[0-2]$d:[0-6]$d:[0-6]$d[+-]$d$d:$d$d) : ;;
	*) start_date=$(date -v -${start_date} -Iseconds);;
	esac
}

main "$@"
