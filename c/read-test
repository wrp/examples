#!/bin/sh

exe=./dynamic-read

die() { echo "$*"; exit 1; } >&2

expect() {
	out=$(printf "$1" | $exe)
	if ! test "$out" = "$2"; then
		die "Got $out, expected '$2' for inpput '$1'"
	fi
}

nl='
'
expect 'foo bar\none two\n' "rab oof${nl}owt eno"
expect 'foo\nbar' "oof${nl}rab"
expect abc cba

count=0
start_time="$(date +%s)"
for i in *; do
	test -f "$i" || continue
	: $(( count += 1 ))
	if ! $exe "$i" | $exe | cmp - "$i"; then
		if ! test "$(stat -c '%Y' "$i")" -lt "$start"; then
			# File recently modified.  Ignore test.
			: $(( count -= 1 ))
		else
			die "Okay for $count files, but failed on $i"
		fi
	fi
done
if test "$count" -lt 10; then
	echo "Not enough tests" >&2
	exit 77
fi
