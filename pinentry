#!/usr/bin/env python3
import sys
import os
import termios
import tty as ttymod

def getpass_tty(prompt="Password: "):
    """Get password from controlling terminal"""
    tty_path = os.environ.get('GPG_TTY')
    if not tty_path:
        try:
            tty_path = os.ttyname(sys.stderr.fileno())
        except:
            tty_path = '/dev/tty'

    try:
        with open(tty_path, 'r+', buffering=1) as tty_file:
            fd = tty_file.fileno()
            old_settings = termios.tcgetattr(fd)
            try:
                # Turn off echo
                new_settings = list(old_settings)
                new_settings[3] = new_settings[3] & ~termios.ECHO & ~termios.ICANON
                termios.tcsetattr(fd, termios.TCSADRAIN, new_settings)

                # Write prompt
                tty_file.write(prompt)
                tty_file.flush()

                # Read password character by character
                password = []
                while True:
                    char = tty_file.read(1)
                    if char in ('\n', '\r'):
                        break
                    elif char in ('\x7f', '\x08'):  # Backspace
                        if password:
                            password.pop()
                    elif char == '\x03':  # Ctrl-C
                        raise KeyboardInterrupt
                    else:
                        password.append(char)

                # Write newline
                tty_file.write('\n')
                tty_file.flush()

                return ''.join(password)
            finally:
                termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
    except Exception as e:
        return None

print("OK Pleased to meet you", flush=True)

desc = ""
prompt = "Password:"
repeat_prompt = "Repeat:"
error_msg = ""

for line in sys.stdin:
    line = line.strip()
    cmd = line.split()[0] if line else ""

    if cmd == "GETPIN":
        try:
            if error_msg:
                pass  # Could display error but skipping for now

            passphrase = getpass_tty(prompt + " ")
            if passphrase is None or passphrase == "":
                print("ERR 83886179 Operation cancelled", flush=True)
            else:
                print(f"D {passphrase}", flush=True)
                print("OK", flush=True)

            error_msg = ""
        except (KeyboardInterrupt, EOFError):
            print("ERR 83886179 Operation cancelled", flush=True)
    elif cmd == "SETDESC":
        desc = line[8:] if len(line) > 8 else ""
        print("OK", flush=True)
    elif cmd == "SETPROMPT":
        prompt = line[10:] if len(line) > 10 else "Password:"
        print("OK", flush=True)
    elif cmd == "SETREPEAT":
        repeat_prompt = line[10:] if len(line) > 10 else "Repeat:"
        print("OK", flush=True)
    elif cmd == "SETERROR":
        error_msg = line[9:] if len(line) > 9 else ""
        print("OK", flush=True)
    elif cmd in ["SETTITLE", "SETOK", "SETCANCEL", "SETNOTOK", "SETQUALITYBAR", "SETQUALITYBAR_TT", "SETKEYINFO", "SETREPEATERROR", "SETREPEATOK", "SETGENPIN", "SETGENPIN_TT"]:
        print("OK", flush=True)
    elif cmd == "GETINFO":
        arg = line.split()[1] if len(line.split()) > 1 else ""
        if arg == "pid":
            print(f"D {os.getpid()}", flush=True)
        elif arg == "version":
            print("D 1.0.0", flush=True)
        elif arg == "flavor":
            print("D tty", flush=True)
        elif arg == "ttyinfo":
            print("D - - -", flush=True)
        print("OK", flush=True)
    elif cmd.startswith("OPTION"):
        print("OK", flush=True)
    elif cmd == "BYE":
        print("OK closing connection", flush=True)
        sys.exit(0)
    elif cmd == "":
        continue
    else:
        print("OK", flush=True)
